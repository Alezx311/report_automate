# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Microsoft Graph API

## –ü–µ—Ä–µ–≤–∞–≥–∏ Graph API –Ω–∞–¥ IMAP

- **–ë—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è** - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î OAuth 2.0 –∑–∞–º—ñ—Å—Ç—å App Passwords
- **–®–≤–∏–¥—à–∞ —Ä–æ–±–æ—Ç–∞** - –ø—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –¥–æ API Microsoft
- **–ë—ñ–ª—å—à–µ –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π** - –¥–æ—Å—Ç—É–ø –¥–æ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π –ª–∏—Å—Ç—ñ–≤
- **–ö—Ä–∞—â–∞ –±–µ–∑–ø–µ–∫–∞** - —Ç–æ–∫–µ–Ω–∏ –∑–∞–º—ñ—Å—Ç—å –ø–∞—Ä–æ–ª—ñ–≤

## –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Azure AD App Registration

1. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –Ω–∞ [Azure Portal](https://portal.azure.com)
2. –í–∏–±–µ—Ä—ñ—Ç—å **Azure Active Directory** ‚Üí **App registrations**
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **New registration**

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:
- **Name**: `Report Automate Mail Reader` (–∞–±–æ –±—É–¥—å-—è–∫–∞ –Ω–∞–∑–≤–∞)
- **Supported account types**: `Accounts in this organizational directory only`
- **Redirect URI**: –∑–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º
- –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Register**

## –ö—Ä–æ–∫ 2: –û—Ç—Ä–∏–º–∞–Ω–Ω—è Tenant ID —Ç–∞ Client ID

–ü—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è App Registration –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ:
- **Application (client) ID** - —Ü–µ –≤–∞—à `AZURE_CLIENT_ID`
- **Directory (tenant) ID** - —Ü–µ –≤–∞—à `AZURE_TENANT_ID`

–°–∫–æ–ø—ñ—é–π—Ç–µ —Ü—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ `.env` —Ñ–∞–π–ª.

## –ö—Ä–æ–∫ 3: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Client Secret

1. –í –º–µ–Ω—é –∑–ª—ñ–≤–∞ –≤–∏–±–µ—Ä—ñ—Ç—å **Certificates & secrets**
2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **New client secret**
3. –í–≤–µ–¥—ñ—Ç—å –æ–ø–∏—Å: `Report Automate Secret`
4. –í–∏–±–µ—Ä—ñ—Ç—å —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ 24 –º—ñ—Å—è—Ü—ñ)
5. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Add**
6. **–í–ê–ñ–õ–ò–í–û**: –°–∫–æ–ø—ñ—é–π—Ç–µ **Value** —Å–µ–∫—Ä–µ—Ç—É –ó–ê–†–ê–ó - –≤—ñ–Ω –±—ñ–ª—å—à–µ –Ω–µ –±—É–¥–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π!
7. –í—Å—Ç–∞–≤—Ç–µ —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ `.env` —è–∫ `AZURE_CLIENT_SECRET`

## –ö—Ä–æ–∫ 4: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è API Permissions

1. –í –º–µ–Ω—é –∑–ª—ñ–≤–∞ –≤–∏–±–µ—Ä—ñ—Ç—å **API permissions**
2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Add a permission**
3. –í–∏–±–µ—Ä—ñ—Ç—å **Microsoft Graph**
4. –í–∏–±–µ—Ä—ñ—Ç—å **Delegated permissions**
5. –î–æ–¥–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –¥–æ–∑–≤–æ–ª–∏:
   - `Mail.Read` - —á–∏—Ç–∞–Ω–Ω—è –ø–æ—à—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
   - `Mail.ReadWrite` - —á–∏—Ç–∞–Ω–Ω—è —Ç–∞ –ø–æ–∑–Ω–∞—á–µ–Ω–Ω—è –ª–∏—Å—Ç—ñ–≤ —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö
   - `User.Read` - –±–∞–∑–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
   - `offline_access` - –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤

6. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Add permissions**
7. **–í–ê–ñ–õ–ò–í–û**: –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Grant admin consent for [Your Organization]**
   - –¶–µ –ø–æ—Ç—Ä–µ–±—É—î –ø—Ä–∞–≤ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
   - –ë–µ–∑ —Ü—å–æ–≥–æ –∫—Ä–æ–∫—É –¥–æ–¥–∞—Ç–æ–∫ –Ω–µ –∑–º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏

## –ö—Ä–æ–∫ 5: –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è Resource Owner Password Credentials (ROPC)

**–í–ê–ñ–õ–ò–í–û**: ROPC flow –º–∞—î –±—É—Ç–∏ —è–≤–Ω–æ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π –≤ Azure AD.

### –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è ROPC –¥–ª—è –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó:

1. –í **Azure Active Directory** ‚Üí **App registrations** ‚Üí –≤–∞—à –¥–æ–¥–∞—Ç–æ–∫
2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –≤ **Manifest**
3. –ó–Ω–∞–π–¥—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `"allowPublicClient"`
4. –ó–º—ñ–Ω—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ `true`:
   ```json
   "allowPublicClient": true
   ```
5. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **Save**

### –í–∞–∂–ª–∏–≤—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è –ø—Ä–æ ROPC:

‚ö†Ô∏è **ROPC flow –≤–∏–º–∞–≥–∞—î –æ—Å–æ–±–ª–∏–≤–∏—Ö —É–º–æ–≤:**
- –ü–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- –ù–µ –ø—Ä–∞—Ü—é—î –∑ –∞–∫–∞—É–Ω—Ç–∞–º–∏, —è–∫—ñ –º–∞—é—Ç—å —É–≤—ñ–º–∫–Ω–µ–Ω—É MFA (Multi-Factor Authentication)
- –ù–µ –ø—Ä–∞—Ü—é—î –∑ —Ñ–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω–∏–º–∏ –∞–∫–∞—É–Ω—Ç–∞–º–∏
- Microsoft —Ä–µ–∫–æ–º–µ–Ω–¥—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ flow –¥–ª—è production

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏ ROPC:**
- **Device Code Flow** - –¥–ª—è –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤ –±–µ–∑ –±—Ä–∞—É–∑–µ—Ä–∞
- **Authorization Code Flow** - –¥–ª—è –≤–µ–±-–¥–æ–¥–∞—Ç–∫—ñ–≤
- **Client Credentials Flow** - –¥–ª—è server-to-server

## –ö—Ä–æ–∫ 6: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è .env —Ñ–∞–π–ª—É

–î–æ–¥–∞–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –≤ –≤–∞—à `.env` —Ñ–∞–π–ª:

```env
# Microsoft Graph API Configuration
AZURE_TENANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
AZURE_CLIENT_SECRET=your-client-secret-value-here
GRAPH_API_USER=your-email@company.com
GRAPH_API_PASSWORD=your-password
```

## –ö—Ä–æ–∫ 7: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

1. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫: `npm start`
2. –í–∏–±–µ—Ä—ñ—Ç—å –≤–∫–ª–∞–¥–∫—É **‚òÅÔ∏è Graph API**
3. –ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è (—è–∫—â–æ –≤–æ–Ω–∏ –Ω–µ –∑–∞–ø–æ–≤–Ω–∏–ª–∏—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑ .env)
4. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è**
5. –Ø–∫—â–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ, –∑'—è–≤–∏—Ç—å—Å—è –∑–µ–ª–µ–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —ñ–º–µ–Ω–µ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
6. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å **üìÅ –í–∏–±—Ä–∞—Ç–∏ –ø–∞–ø–∫–∏** –¥–ª—è –≤–∏–±–æ—Ä—É –ø–∞–ø–æ–∫ –ø–æ—à—Ç–∏
7. –í–∏–±–µ—Ä—ñ—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø–∞–ø–∫–∏ —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å **üöÄ –ü–∞—Ä—Å–∏—Ç–∏ —Ç–∞ –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–≤—ñ—Ç**

## –ú–æ–∂–ª–∏–≤—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–∞ —ó—Ö –≤–∏—Ä—ñ—à–µ–Ω–Ω—è

### "AADSTS50126: Invalid username or password"
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å email —Ç–∞ –ø–∞—Ä–æ–ª—è
- –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –Ω–∞ –∞–∫–∞—É–Ω—Ç—ñ –Ω–µ–º–∞—î MFA

### "AADSTS650053: The application is trying to use ROPC flow"
- ROPC flow –Ω–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π –¥–ª—è –≤–∞—à–æ—ó –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó
- –ü–æ—Ç—Ä—ñ–±–µ–Ω –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–ª—è —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è
- –í Azure AD ‚Üí Properties ‚Üí —É–≤—ñ–º–∫–Ω—ñ—Ç—å "Public client flows"

### "AADSTS700016: Application not found in directory"
- –ù–µ–≤—ñ—Ä–Ω–∏–π Tenant ID –∞–±–æ Client ID
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ .env

### "AADSTS7000215: Invalid client secret"
- Client Secret –Ω–µ–≤—ñ—Ä–Ω–∏–π –∞–±–æ –ø—Ä–æ—Ç–µ—Ä–º—ñ–Ω–æ–≤–∞–Ω–∏–π
- –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Å–µ–∫—Ä–µ—Ç –≤ Azure Portal

### "Insufficient privileges to complete the operation"
- –ù–µ –Ω–∞–¥–∞–Ω—ñ admin consent –¥–ª—è permissions
- –ü–æ–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ö—Ä–æ–∫—É 4 —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "Grant admin consent"

## –ë–µ–∑–ø–µ–∫–∞

üîí **–í–∞–∂–ª–∏–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏ –ø—Ä–æ –±–µ–∑–ø–µ–∫—É:**

1. **–ù—ñ–∫–æ–ª–∏ –Ω–µ –ø—É–±–ª—ñ–∫—É–π—Ç–µ .env —Ñ–∞–π–ª –≤ Git**
   - –î–æ–¥–∞–π—Ç–µ `.env` –≤ `.gitignore`

2. **Client Secret —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º**
   - –ó–±–µ—Ä—ñ–≥–∞–π—Ç–µ –π–æ–≥–æ –≤ –±–µ–∑–ø–µ—Ü—ñ
   - –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–∏ (–∫–æ–∂–Ω—ñ 6-12 –º—ñ—Å—è—Ü—ñ–≤)

3. **ROPC flow –Ω–µ —î –Ω–∞–π–±–µ–∑–ø–µ—á–Ω—ñ—à–∏–º**
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
   - –î–ª—è production —Ä–æ–∑–≥–ª—è–Ω—å—Ç–µ —ñ–Ω—à—ñ OAuth flows

4. **–û–±–º–µ–∂—Ç–µ permissions**
   - –ù–∞–¥–∞–≤–∞–π—Ç–µ —Ç—ñ–ª—å–∫–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–æ–∑–≤–æ–ª–∏
   - –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–æ–∑–≤–æ–ª–∏

## –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

- [Microsoft Graph API Documentation](https://docs.microsoft.com/en-us/graph/overview)
- [OAuth 2.0 ROPC Flow](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth-ropc)
- [Microsoft Graph Mail API](https://docs.microsoft.com/en-us/graph/api/resources/mail-api-overview)

## –ü—ñ–¥—Ç—Ä–∏–º–∫–∞

–Ø–∫—â–æ —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º–∏:
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ –∫—Ä–æ–∫–∏ –≤–∏—â–µ
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞ (F12)
3. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤—Å—ñ permissions –Ω–∞–¥–∞–Ω—ñ —Ç–∞ approved
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ `allowPublicClient: true` –≤ manifest
